name: "[TEST] DataWorks Integration - Step by Step"

on:
  workflow_dispatch:
    inputs:
      step:
        description: 'æ‰§è¡Œæ­¥éª¤'
        required: true
        default: 'check_cli'
        type: choice
        options:
          - check_cli
          - check_datasources
          - create_oss_ds
          - create_odps_ds
          - create_node
          - all
      project_dir:
        description: 'é¡¹ç›®ç›®å½• (é»˜è®¤ projects/Test)'
        required: false
        default: 'projects/Test'
      file_id:
        description: '(submit/deploy) ä» create_job è·å–çš„ FileId'
        required: false
        default: ''

env:
  DATAWORKS_PROJECT_ID: ${{ secrets.DATAWORKS_PROJECT_ID }}
  ALIBABA_CLOUD_ACCESS_KEY_ID: ${{ secrets.ALIYUN_ACCESS_KEY_ID }}
  ALIBABA_CLOUD_ACCESS_KEY_SECRET: ${{ secrets.ALIYUN_ACCESS_KEY_SECRET }}
  ALIYUN_REGION: ${{ secrets.ALIYUN_REGION }}

jobs:
  test:
    name: "Test - ${{ github.event.inputs.step }}"
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install -r scripts/requirements.txt

      # ---- åˆ†æ­¥æ‰§è¡Œ ----
      - name: "Run: ${{ github.event.inputs.step }}"
        if: ${{ github.event.inputs.step != 'all' }}
        id: run_step
        run: |
          ARGS="--step ${{ github.event.inputs.step }}"
          ARGS="$ARGS --project-dir ${{ github.event.inputs.project_dir }}"
          
          FILE_ID="${{ github.event.inputs.file_id }}"
          if [ -n "$FILE_ID" ]; then
            ARGS="$ARGS --file-id $FILE_ID"
          fi
          
          echo "Running: python scripts/deploy.py $ARGS"
          python scripts/deploy.py $ARGS

      # ---- å…¨é‡æ‰§è¡Œ ----
      - name: "Run: Full deployment (all)"
        if: ${{ github.event.inputs.step == 'all' }}
        run: |
          python scripts/deploy.py \
            --projects-dir projects \
            --projects "$(basename ${{ github.event.inputs.project_dir }})"

      # ---- æ±‡æ€» ----
      - name: Summary
        if: always()
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘              Test Run Complete                           â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘  Step:       ${{ github.event.inputs.step }}"
          echo "â•‘  Project:    ${{ github.event.inputs.project_dir }}"
          echo "â•‘  Project ID: ${{ env.DATAWORKS_PROJECT_ID }}"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“‹ æµ‹è¯•æµç¨‹:"
          echo "  check_cli          â†’ éªŒè¯ SDK è¿æ¥ & æŸ¥çœ‹èµ„æºç»„"
          echo "  check_datasources  â†’ æ£€æŸ¥æ•°æ®æºæ˜¯å¦å­˜åœ¨"
          echo "  create_oss_ds      â†’ åˆ›å»º OSS æ•°æ®æº"
          echo "  create_odps_ds     â†’ åˆ›å»º MaxCompute æ•°æ®æº"
          echo "  create_job         â†’ åˆ›å»ºåŒæ­¥ Job (è¾“å‡º FileId)"
          echo "  submit             â†’ æäº¤ä»»åŠ¡ (éœ€è¦ FileId)"
          echo "  deploy             â†’ å‘å¸ƒåˆ°ç”Ÿäº§ (éœ€è¦ FileId)"
          echo "  all                â†’ æ‰§è¡Œå®Œæ•´æµç¨‹"
